# 🤖 AI Suggestion System Documentation

## 📋 Genel Bakış

Bu dokümantasyon, Benalsam projesinde uygulanan AI Suggestion sisteminin teknik detaylarını, veritabanı yapısını, API endpoint'lerini ve kullanım örneklerini içerir.

## 🏗️ Sistem Mimarisi

### Veritabanı Yapısı

#### 1. Categories Tablosu Güncellemeleri

```sql
-- Categories tablosuna eklenen AI field'ları
ALTER TABLE categories ADD COLUMN IF NOT EXISTS ai_suggestions jsonb DEFAULT '{}';
ALTER TABLE categories ADD COLUMN IF NOT EXISTS ai_enhanced boolean DEFAULT false;
```

**Field Açıklamaları:**
- `ai_suggestions`: JSONB formatında AI önerilerini saklar
- `ai_enhanced`: Kategorinin AI ile geliştirilip geliştirilmediğini belirtir

#### 2. Category Attributes Tablosu Güncellemeleri

```sql
-- Category attributes için AI enhancement
ALTER TABLE category_attributes ADD COLUMN IF NOT EXISTS ai_enhanced boolean DEFAULT false;
ALTER TABLE category_attributes ADD COLUMN IF NOT EXISTS ai_suggestions jsonb DEFAULT '{}';
```

**Field Açıklamaları:**
- `ai_enhanced`: Attribute'un AI ile geliştirilip geliştirilmediğini belirtir
- `ai_suggestions`: Attribute için AI önerilerini saklar

#### 3. Category AI Suggestions Tablosu

```sql
CREATE TABLE IF NOT EXISTS category_ai_suggestions (
    id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    category_id bigint REFERENCES categories(id) ON DELETE CASCADE,
    suggestion_type text NOT NULL CHECK (suggestion_type IN ('title', 'description', 'attributes', 'keywords')),
    suggestion_data jsonb NOT NULL,
    confidence_score numeric(3,2) CHECK (confidence_score >= 0 AND confidence_score <= 1),
    is_approved boolean DEFAULT false,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);
```

**Tablo Açıklaması:**
- `id`: Birincil anahtar
- `category_id`: Kategori referansı (CASCADE DELETE)
- `suggestion_type`: Öneri türü (title, description, attributes, keywords)
- `suggestion_data`: JSONB formatında öneri verisi
- `confidence_score`: 0-1 arası güven skoru
- `is_approved`: Onay durumu
- `created_at/updated_at`: Zaman damgaları

### Index Yapısı

```sql
-- Search enhancement index'leri
CREATE INDEX IF NOT EXISTS idx_categories_ai_suggestions ON categories USING gin(ai_suggestions);
CREATE INDEX IF NOT EXISTS idx_categories_search ON categories USING gin(to_tsvector('turkish', name || ' ' || COALESCE(path, '')));
CREATE INDEX IF NOT EXISTS idx_category_ai_suggestions_category_id ON category_ai_suggestions(category_id);
CREATE INDEX IF NOT EXISTS idx_category_ai_suggestions_type ON category_ai_suggestions(suggestion_type);
CREATE INDEX IF NOT EXISTS idx_category_ai_suggestions_approved ON category_ai_suggestions(is_approved);
```

**Index Açıklamaları:**
- `idx_categories_ai_suggestions`: AI suggestions için GIN index
- `idx_categories_search`: Türkçe full-text search için GIN index
- `idx_category_ai_suggestions_category_id`: Kategori ID için B-tree index
- `idx_category_ai_suggestions_type`: Öneri türü için B-tree index
- `idx_category_ai_suggestions_approved`: Onay durumu için B-tree index

### Güvenlik (RLS)

```sql
-- Row Level Security aktifleştirme
ALTER TABLE category_ai_suggestions ENABLE ROW LEVEL SECURITY;

-- Admin kullanıcılar için policy
CREATE POLICY "Admin users can manage category AI suggestions" ON category_ai_suggestions
    FOR ALL USING (auth.jwt() ->> 'role' = 'SUPER_ADMIN' OR auth.jwt() ->> 'role' = 'ADMIN');
```

### Otomatik Güncelleme

```sql
-- Updated_at trigger function
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END;
$$ language 'plpgsql';

-- Trigger oluşturma
CREATE TRIGGER update_category_ai_suggestions_updated_at 
    BEFORE UPDATE ON category_ai_suggestions 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

## 🔧 API Endpoint'leri

### Mevcut AI Suggestions API

#### 1. Ana AI Suggestions Endpoint

```typescript
// GET /api/v1/ai-suggestions
interface AISuggestionsRequest {
  q?: string;           // Arama sorgusu
  categoryId?: number;  // Kategori ID'si
}

interface AISuggestionsResponse {
  success: boolean;
  data: {
    suggestions: AISuggestion[];
    total: number;
    query?: string;
    categoryId?: number;
    generatedAt: string;
  };
}

interface AISuggestion {
  id: string;
  text: string;
  type: 'category' | 'search' | 'trending' | 'popular';
  score: number;
  category?: Category;
  metadata?: {
    searchCount?: number;
    lastSearched?: string;
    trending?: boolean;
  };
}
```

#### 2. Trending Suggestions Endpoint

```typescript
// GET /api/v1/ai-suggestions/trending
interface TrendingSuggestionsResponse {
  success: boolean;
  data: {
    suggestions: AISuggestion[];
    total: number;
  };
}
```

#### 3. Popular Suggestions Endpoint

```typescript
// GET /api/v1/ai-suggestions/popular
interface PopularSuggestionsResponse {
  success: boolean;
  data: {
    suggestions: AISuggestion[];
    total: number;
  };
}
```

### Yeni AI Suggestions API'ları (Önerilen)

#### 1. Category AI Suggestions

```typescript
// GET /api/v1/categories/:id/ai-suggestions
interface CategoryAISuggestionsRequest {
  categoryId: number;
  type?: 'title' | 'description' | 'attributes' | 'keywords';
  approved?: boolean;
}

interface CategoryAISuggestionsResponse {
  success: boolean;
  data: {
    categoryId: number;
    suggestions: CategoryAISuggestion[];
    total: number;
  };
}

interface CategoryAISuggestion {
  id: number;
  categoryId: number;
  suggestionType: string;
  suggestionData: any;
  confidenceScore: number;
  isApproved: boolean;
  createdAt: string;
  updatedAt: string;
}
```

#### 2. AI Suggestions Yönetimi

```typescript
// POST /api/v1/categories/:id/ai-suggestions
interface CreateAISuggestionRequest {
  categoryId: number;
  suggestionType: 'title' | 'description' | 'attributes' | 'keywords';
  suggestionData: any;
  confidenceScore: number;
}

// PUT /api/v1/ai-suggestions/:id
interface UpdateAISuggestionRequest {
  suggestionData?: any;
  confidenceScore?: number;
  isApproved?: boolean;
}

// DELETE /api/v1/ai-suggestions/:id
interface DeleteAISuggestionResponse {
  success: boolean;
  message: string;
}
```

## 📊 Veri Yapısı Örnekleri

### 1. Categories AI Suggestions JSONB Yapısı

```json
{
  "ai_suggestions": {
    "title_suggestions": [
      {
        "text": "Emlak İlanı",
        "confidence": 0.95,
        "generated_at": "2025-08-25T14:42:25Z"
      },
      {
        "text": "Gayrimenkul",
        "confidence": 0.88,
        "generated_at": "2025-08-25T14:42:25Z"
      }
    ],
    "description_suggestions": [
      {
        "text": "Bu emlak ilanı için detaylı açıklama",
        "confidence": 0.92,
        "generated_at": "2025-08-25T14:42:25Z"
      }
    ],
    "keywords": [
      "emlak",
      "gayrimenkul",
      "konut",
      "ev",
      "daire"
    ],
    "last_updated": "2025-08-25T14:42:25Z"
  }
}
```

### 2. Category AI Suggestions Tablosu Örnek Verisi

```sql
-- Örnek veri ekleme
INSERT INTO category_ai_suggestions (category_id, suggestion_type, suggestion_data, confidence_score, is_approved)
VALUES 
(618, 'title', '{"suggestions": ["Emlak İlanı", "Gayrimenkul", "Konut"]}', 0.95, true),
(618, 'description', '{"suggestions": ["Bu emlak ilanı için detaylı açıklama", "Gayrimenkul özellikleri"]}', 0.88, true),
(618, 'keywords', '{"suggestions": ["emlak", "gayrimenkul", "konut", "ev", "daire"]}', 0.92, true);
```

### 3. Category Attributes AI Enhancement

```json
{
  "ai_enhanced": true,
  "ai_suggestions": {
    "attribute_suggestions": [
      {
        "key": "room_count",
        "label": "Oda Sayısı",
        "type": "number",
        "confidence": 0.95
      },
      {
        "key": "floor",
        "label": "Kat",
        "type": "number",
        "confidence": 0.88
      }
    ],
    "validation_rules": [
      {
        "rule": "min_value",
        "value": 1,
        "field": "room_count"
      }
    ]
  }
}
```

## 🔍 Kullanım Örnekleri

### 1. Kategori AI Suggestions'larını Getirme

```sql
-- Belirli bir kategori için AI suggestions'ları getir
SELECT 
    cas.id,
    c.name as category_name,
    cas.suggestion_type,
    cas.suggestion_data,
    cas.confidence_score,
    cas.is_approved,
    cas.created_at
FROM category_ai_suggestions cas
JOIN categories c ON cas.category_id = c.id
WHERE cas.category_id = 618
ORDER BY cas.confidence_score DESC;
```

### 2. AI Enhanced Kategorileri Listeleme

```sql
-- AI ile geliştirilmiş kategorileri getir
SELECT 
    id,
    name,
    path,
    ai_enhanced,
    ai_suggestions
FROM categories 
WHERE ai_enhanced = true
ORDER BY name;
```

### 3. Yüksek Güven Skorlu Önerileri Getirme

```sql
-- Güven skoru 0.9'dan yüksek onaylı önerileri getir
SELECT 
    cas.*,
    c.name as category_name
FROM category_ai_suggestions cas
JOIN categories c ON cas.category_id = c.id
WHERE cas.confidence_score > 0.9 
AND cas.is_approved = true
ORDER BY cas.confidence_score DESC;
```

### 4. Full-text Search ile AI Suggestions Arama

```sql
-- Türkçe full-text search ile AI suggestions arama
SELECT 
    id,
    name,
    path,
    ai_suggestions
FROM categories 
WHERE to_tsvector('turkish', name || ' ' || COALESCE(path, '')) @@ plainto_tsquery('turkish', 'emlak')
AND ai_enhanced = true;
```

## 🚀 Frontend Entegrasyonu

### 1. AI Suggestions Service

```typescript
// benalsam-web/src/services/aiSuggestionsService.ts
class AISuggestionsService {
  private readonly CACHE_KEY = 'ai_suggestions_v1';
  private readonly CACHE_TTL = 30 * 60 * 1000; // 30 minutes
  private readonly RATE_LIMIT = 60 * 1000; // 1 minute

  async getSuggestions(query?: string, categoryId?: number): Promise<AISuggestion[]> {
    // Implementation
  }

  async getCategorySuggestions(categoryId: number): Promise<AISuggestion[]> {
    // Implementation
  }

  async getTrendingSuggestions(): Promise<AISuggestion[]> {
    // Implementation
  }

  async getPopularSuggestions(): Promise<AISuggestion[]> {
    // Implementation
  }
}
```

### 2. AI Suggestions Hook

```typescript
// benalsam-web/src/hooks/useAISuggestions.ts
export const useAISuggestions = (query = '', categoryId = null) => {
  const [suggestions, setSuggestions] = useState<AISuggestion[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState(null);

  const fetchSuggestions = useCallback(async () => {
    // Implementation
  }, [query, categoryId]);

  return {
    suggestions,
    isLoading,
    error,
    fetchSuggestions
  };
};
```

### 3. AI Suggestions Component

```typescript
// benalsam-web/src/components/AISuggestions.jsx
const AISuggestions = ({ 
  query = '', 
  categoryId = null, 
  onSuggestionClick = null,
  maxSuggestions = 10,
  showTrending = true,
  showPopular = true
}) => {
  // Implementation
};
```

## 🔧 Elasticsearch Entegrasyonu

### 1. Listings Index AI Enhancement

```json
{
  "properties": {
    "ai_suggestions": {
      "type": "object",
      "properties": {
        "title_suggestions": { "type": "text", "analyzer": "turkish_analyzer" },
        "description_suggestions": { "type": "text", "analyzer": "turkish_analyzer" },
        "keywords_suggestions": { "type": "keyword" },
        "category_suggestions": { "type": "keyword" },
        "confidence_score": { "type": "float" },
        "generated_at": { "type": "date" }
      }
    },
    "ai_enhanced": { "type": "boolean" },
    "ai_generated_title": { "type": "text", "analyzer": "turkish_analyzer" },
    "ai_generated_description": { "type": "text", "analyzer": "turkish_analyzer" }
  }
}
```

### 2. Categories Index

```json
{
  "categories": {
    "mappings": {
      "properties": {
        "id": { "type": "integer" },
        "name": { "type": "text", "analyzer": "turkish_analyzer" },
        "path": { "type": "text" },
        "parent_id": { "type": "integer" },
        "level": { "type": "integer" },
        "ai_suggestions": {
          "type": "object",
          "properties": {
            "popular_keywords": { "type": "keyword" },
            "trending_terms": { "type": "keyword" },
            "related_categories": { "type": "keyword" },
            "confidence_score": { "type": "float" }
          }
        },
        "ai_enhanced": { "type": "boolean" }
      }
    }
  }
}
```

## 📈 Performans Optimizasyonu

### 1. Cache Stratejisi

```typescript
// Redis cache keys
const CACHE_KEYS = {
  AI_SUGGESTIONS: 'ai_suggestions_v1',
  CATEGORY_AI_SUGGESTIONS: 'category_ai_suggestions',
  TRENDING_SUGGESTIONS: 'trending_suggestions',
  POPULAR_SUGGESTIONS: 'popular_suggestions'
};

// Cache TTL
const CACHE_TTL = {
  AI_SUGGESTIONS: 30 * 60, // 30 minutes
  CATEGORY_AI_SUGGESTIONS: 60 * 60, // 1 hour
  TRENDING_SUGGESTIONS: 15 * 60, // 15 minutes
  POPULAR_SUGGESTIONS: 60 * 60 // 1 hour
};
```

### 2. Rate Limiting

```typescript
// Rate limiting configuration
const RATE_LIMITS = {
  AI_SUGGESTIONS: {
    windowMs: 60 * 1000, // 1 minute
    max: 50 // 50 requests per minute
  },
  CATEGORY_AI_SUGGESTIONS: {
    windowMs: 60 * 1000, // 1 minute
    max: 100 // 100 requests per minute
  }
};
```

### 3. Database Optimizasyonu

```sql
-- Partitioning için öneriler
-- Büyük veri için category_ai_suggestions tablosunu partition'la
CREATE TABLE category_ai_suggestions_2025 PARTITION OF category_ai_suggestions
FOR VALUES FROM ('2025-01-01') TO ('2026-01-01');

-- Index maintenance
REINDEX INDEX CONCURRENTLY idx_categories_ai_suggestions;
ANALYZE categories;
ANALYZE category_ai_suggestions;
```

## 🔒 Güvenlik

### 1. Authentication & Authorization

```typescript
// Admin-only endpoints
const requireAdmin = (req, res, next) => {
  const role = req.user?.role;
  if (role !== 'SUPER_ADMIN' && role !== 'ADMIN') {
    return res.status(403).json({
      success: false,
      message: 'Admin access required'
    });
  }
  next();
};

// Rate limiting middleware
const aiSuggestionsLimiter = rateLimit({
  windowMs: 60 * 1000,
  max: 50,
  message: 'Too many AI suggestions requests'
});
```

### 2. Input Validation

```typescript
// AI suggestion validation
const validateAISuggestion = (data) => {
  const schema = Joi.object({
    categoryId: Joi.number().integer().positive().required(),
    suggestionType: Joi.string().valid('title', 'description', 'attributes', 'keywords').required(),
    suggestionData: Joi.object().required(),
    confidenceScore: Joi.number().min(0).max(1).required()
  });
  
  return schema.validate(data);
};
```

## 🧪 Test Senaryoları

### 1. Unit Tests

```typescript
// AI Suggestions Service Tests
describe('AISuggestionsService', () => {
  test('should get suggestions for query', async () => {
    const service = new AISuggestionsService();
    const suggestions = await service.getSuggestions('emlak');
    expect(suggestions).toBeDefined();
    expect(suggestions.length).toBeGreaterThan(0);
  });

  test('should get category suggestions', async () => {
    const service = new AISuggestionsService();
    const suggestions = await service.getCategorySuggestions(618);
    expect(suggestions).toBeDefined();
  });
});
```

### 2. Integration Tests

```typescript
// API Integration Tests
describe('AI Suggestions API', () => {
  test('GET /api/v1/ai-suggestions should return suggestions', async () => {
    const response = await request(app)
      .get('/api/v1/ai-suggestions')
      .query({ q: 'emlak' });
    
    expect(response.status).toBe(200);
    expect(response.body.success).toBe(true);
    expect(response.body.data.suggestions).toBeDefined();
  });
});
```

### 3. Database Tests

```sql
-- Database function tests
SELECT 
    COUNT(*) as total_suggestions,
    AVG(confidence_score) as avg_confidence,
    COUNT(CASE WHEN is_approved = true THEN 1 END) as approved_count
FROM category_ai_suggestions
WHERE category_id = 618;
```

## 📊 Monitoring & Analytics

### 1. Performance Metrics

```typescript
// Performance monitoring
const monitorAISuggestions = {
  responseTime: new Histogram({
    name: 'ai_suggestions_response_time',
    help: 'AI suggestions response time'
  }),
  
  requestCount: new Counter({
    name: 'ai_suggestions_requests_total',
    help: 'Total AI suggestions requests'
  }),
  
  cacheHitRate: new Gauge({
    name: 'ai_suggestions_cache_hit_rate',
    help: 'AI suggestions cache hit rate'
  })
};
```

### 2. Error Tracking

```typescript
// Error tracking
const trackAISuggestionError = (error, context) => {
  logger.error('AI Suggestion Error', {
    error: error.message,
    stack: error.stack,
    context,
    timestamp: new Date().toISOString()
  });
  
  // Send to monitoring service
  monitoringService.captureException(error, {
    tags: { feature: 'ai_suggestions' },
    extra: context
  });
};
```

## 🔄 Migration & Deployment

### 1. Migration Script

```sql
-- Migration: 20250825173000_ai_suggestions_categories.sql
-- AI Suggestion Features for Categories

-- 1. Categories tablosuna AI field'ları ekle
ALTER TABLE categories ADD COLUMN IF NOT EXISTS ai_suggestions jsonb DEFAULT '{}';
ALTER TABLE categories ADD COLUMN IF NOT EXISTS ai_enhanced boolean DEFAULT false;

-- 2. Category attributes için AI enhancement
ALTER TABLE category_attributes ADD COLUMN IF NOT EXISTS ai_enhanced boolean DEFAULT false;
ALTER TABLE category_attributes ADD COLUMN IF NOT EXISTS ai_suggestions jsonb DEFAULT '{}';

-- 3. Category AI suggestions tablosu oluştur
CREATE TABLE IF NOT EXISTS category_ai_suggestions (
    id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    category_id bigint REFERENCES categories(id) ON DELETE CASCADE,
    suggestion_type text NOT NULL CHECK (suggestion_type IN ('title', 'description', 'attributes', 'keywords')),
    suggestion_data jsonb NOT NULL,
    confidence_score numeric(3,2) CHECK (confidence_score >= 0 AND confidence_score <= 1),
    is_approved boolean DEFAULT false,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);

-- 4. Search enhancement index'leri
CREATE INDEX IF NOT EXISTS idx_categories_ai_suggestions ON categories USING gin(ai_suggestions);
CREATE INDEX IF NOT EXISTS idx_categories_search ON categories USING gin(to_tsvector('turkish', name || ' ' || COALESCE(path, '')));
CREATE INDEX IF NOT EXISTS idx_category_ai_suggestions_category_id ON category_ai_suggestions(category_id);
CREATE INDEX IF NOT EXISTS idx_category_ai_suggestions_type ON category_ai_suggestions(suggestion_type);
CREATE INDEX IF NOT EXISTS idx_category_ai_suggestions_approved ON category_ai_suggestions(is_approved);

-- 5. RLS (Row Level Security) policies
ALTER TABLE category_ai_suggestions ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Admin users can manage category AI suggestions" ON category_ai_suggestions
    FOR ALL USING (auth.jwt() ->> 'role' = 'SUPER_ADMIN' OR auth.jwt() ->> 'role' = 'ADMIN');

-- 6. Updated_at trigger for category_ai_suggestions
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_category_ai_suggestions_updated_at 
    BEFORE UPDATE ON category_ai_suggestions 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

### 2. Rollback Script

```sql
-- Rollback script
DROP TRIGGER IF EXISTS update_category_ai_suggestions_updated_at ON category_ai_suggestions;
DROP FUNCTION IF EXISTS update_updated_at_column();
DROP POLICY IF EXISTS "Admin users can manage category AI suggestions" ON category_ai_suggestions;
ALTER TABLE category_ai_suggestions DISABLE ROW LEVEL SECURITY;
DROP INDEX IF EXISTS idx_category_ai_suggestions_approved;
DROP INDEX IF EXISTS idx_category_ai_suggestions_type;
DROP INDEX IF EXISTS idx_category_ai_suggestions_category_id;
DROP INDEX IF EXISTS idx_categories_search;
DROP INDEX IF EXISTS idx_categories_ai_suggestions;
DROP TABLE IF EXISTS category_ai_suggestions;
ALTER TABLE category_attributes DROP COLUMN IF EXISTS ai_suggestions;
ALTER TABLE category_attributes DROP COLUMN IF EXISTS ai_enhanced;
ALTER TABLE categories DROP COLUMN IF EXISTS ai_suggestions;
ALTER TABLE categories DROP COLUMN IF EXISTS ai_enhanced;
```

## 📚 Kaynaklar

### 1. Dokümantasyon Linkleri
- [Supabase RLS Documentation](https://supabase.com/docs/guides/auth/row-level-security)
- [PostgreSQL JSONB Documentation](https://www.postgresql.org/docs/current/datatype-json.html)
- [Elasticsearch Turkish Analyzer](https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-turkish-analyzer.html)

### 2. İlgili Dosyalar
- `benalsam-admin-backend/src/routes/aiSuggestions.ts`
- `benalsam-web/src/services/aiSuggestionsService.ts`
- `benalsam-web/src/hooks/useAISuggestions.ts`
- `benalsam-web/src/components/AISuggestions.jsx`

### 3. Test Dosyaları
- `benalsam-admin-backend/src/__tests__/aiSuggestions.test.ts`
- `benalsam-web/src/__tests__/aiSuggestionsService.test.ts`

---

**Son Güncelleme:** 25 Ağustos 2025  
**Versiyon:** 1.0.0  
**Yazar:** AI Assistant  
**Durum:** Aktif ve Kullanımda
