/**
 * Seed Test Listing Script
 * Creates realistic test listings with Unsplash images
 */

import { createClient } from '@supabase/supabase-js'
import dotenv from 'dotenv'
import path from 'path'
import { fileURLToPath } from 'url'
import { dirname } from 'path'

// Get current file's directory (ESM workaround)
const __filename = fileURLToPath(import.meta.url)
const __dirname = dirname(__filename)

// Load environment variables from parent directory
dotenv.config({ path: path.join(__dirname, '../.env.local') })

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!

console.log('ğŸ” Debug - Environment check:')
console.log('   SUPABASE_URL:', supabaseUrl ? 'âœ… Found' : 'âŒ Missing')
console.log('   SERVICE_ROLE_KEY:', supabaseServiceKey ? 'âœ… Found' : 'âŒ Missing')
console.log('')

if (!supabaseUrl || !supabaseServiceKey) {
  console.error('âŒ Missing Supabase credentials')
  console.error('   Make sure .env.local exists in benalsam-web-next/')
  process.exit(1)
}

const supabase = createClient(supabaseUrl, supabaseServiceKey)

// ============================================================================
// UNSPLASH IMAGE FETCHER (via Edge Function)
// ============================================================================

async function fetchUnsplashImage(keyword: string): Promise<string> {
  try {
    console.log(`   ğŸ” Searching Unsplash for: "${keyword}"`)
    
    // Call Supabase Edge Function
    const { data, error } = await supabase.functions.invoke('fetch-unsplash-images', {
      body: { query: keyword }
    })

    if (error) {
      console.error('   âŒ Edge function error:', error)
      throw error
    }

    if (data?.images && data.images.length > 0) {
      const imageUrl = data.images[0].urls.regular
      console.log(`   âœ… Found image: ${imageUrl}`)
      return imageUrl
    }

    // Fallback to source.unsplash.com
    console.warn('   âš ï¸ No images found, using fallback')
    return `https://source.unsplash.com/800x600/?${keyword}`
  } catch (error) {
    console.error('   âŒ Failed to fetch Unsplash image:', error)
    return `https://source.unsplash.com/800x600/?${keyword}`
  }
}

// ============================================================================
// TEST LISTING DATA
// ============================================================================

const USER_IDS = [
  '19a6dcfc-5f3a-494e-ad98-02bcfb135462',
  '3b098846-d952-4ef5-b250-df2b31d0eb15',
  '4d76d17f-b78e-4bc6-a779-0a3eb14ee826',
  '6417b4a3-021b-4649-a83f-a3c9ccbaf522',
  '96d5ffce-6fdc-466c-8b05-a0d8cbf5dc8d',
  'dff1eb99-c85e-49e8-81af-2ba72dd54c2b',
  'e9ae9253-752a-4abe-b0c9-0ee92f81e9c9',
]

const TEST_LISTING = {
  title: 'iPhone 15 Pro Max 256GB Mavi arÄ±yorum [TEST]',
  description: `iPhone 15 Pro Max arÄ±yorum. Tercihen mavi renk, 256GB veya daha fazla hafÄ±za.

Beklentilerim:
- Kutu ve aksesuarlarÄ±yla birlikte
- Ekran ve kasada Ã§izik olmamasÄ±
- Garantili olmasÄ± (Apple Store veya yetkili satÄ±cÄ±)
- FaturalÄ± olmasÄ±

BÃ¼tÃ§em: 60.000â‚º'ye kadar esnek
Lokasyon: Ä°zmir (KarÅŸÄ±yaka, Bornova, Konak Ã§evresi)
Ã–deme: Nakit veya havale

Not: Ciddi satÄ±cÄ±lar lÃ¼tfen fotoÄŸraflarla birlikte teklif versin.

âš ï¸ BU BÄ°R TEST Ä°LANIDIR`,
  category_id: 502, // Elektronik > Telefon > AkÄ±llÄ± Telefon > AkÄ±llÄ± Telefonlar
  budget: 60000,
  location: 'KarÅŸÄ±yaka, Ä°zmir',
  urgency: 'urgent',
  contact_preference: 'both',
  attributes: {
    brand: ['Apple'],
    model: ['iPhone 15 Pro Max'],
    storage: ['256GB'],
    color: ['Mavi'],
    condition: ['SÄ±fÄ±r', 'Ã‡ok iyi']
  },
  user_id: USER_IDS[0] // Ä°lk kullanÄ±cÄ±
}

// ============================================================================
// CREATE LISTING
// ============================================================================

async function createTestListing() {
  try {
    console.log('ğŸš€ Starting test listing creation...\n')

    // 1. Use predefined user ID
    console.log('1ï¸âƒ£ Using test user...')
    const userId = TEST_LISTING.user_id
    console.log(`âœ… User ID: ${userId}\n`)

    // 2. Fetch Unsplash image
    console.log('2ï¸âƒ£ Fetching Unsplash image...')
    const imageUrl = await fetchUnsplashImage('iphone 15 pro max blue')
    console.log(`âœ… Image URL: ${imageUrl}\n`)

    // 3. Get category name (category_path will be auto-generated by triggers)
    console.log('3ï¸âƒ£ Fetching category...')
    const { data: category, error: categoryError } = await supabase
      .from('categories')
      .select('name')
      .eq('id', TEST_LISTING.category_id)
      .single()

    if (categoryError || !category) {
      console.error('   âŒ Category not found:', TEST_LISTING.category_id)
      console.error('   ğŸ’¡ Make sure category ID 502 exists in database')
      process.exit(1)
    }

    console.log(`   âœ… Category: ${category.name}\n`)

    // 4. Create listing
    console.log('4ï¸âƒ£ Creating listing...')
    const { data: listing, error: listingError } = await supabase
      .from('listings')
      .insert({
        user_id: userId,
        title: TEST_LISTING.title,
        description: TEST_LISTING.description,
        category: category.name, // Required NOT NULL field
        category_id: TEST_LISTING.category_id,
        // category_path will be auto-generated by database trigger
        budget: TEST_LISTING.budget,
        location: TEST_LISTING.location,
        urgency: TEST_LISTING.urgency,
        contact_preference: TEST_LISTING.contact_preference,
        main_image_url: imageUrl,
        additional_image_urls: [], // Could add more images
        status: 'active', // Auto-approve for testing
        attributes: TEST_LISTING.attributes,
        accept_terms: true
      })
      .select()
      .single()

    if (listingError) {
      console.error('âŒ Failed to create listing:', listingError)
      process.exit(1)
    }

    console.log(`âœ… Listing created: ${listing.id}\n`)

    // 4. Summary
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
    console.log('ğŸ‰ TEST LISTING CREATED SUCCESSFULLY!')
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
    console.log(`ğŸ“ Title: ${listing.title}`)
    console.log(`ğŸ’° Budget: ${listing.budget.toLocaleString('tr-TR')}â‚º`)
    console.log(`ğŸ“ Location: ${listing.location}`)
    console.log(`ğŸ”— URL: http://localhost:3000/ilan/${listing.id}`)
    console.log(`ğŸ–¼ï¸  Image: ${imageUrl}`)
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n')

    console.log('ğŸ“Š Next steps:')
    console.log('1. Check homepage: http://localhost:3000')
    console.log('2. Check listings page: http://localhost:3000/ilanlar')
    console.log('3. Search for "iPhone": http://localhost:3000/ilanlar?q=iphone')
    console.log('4. If successful, run script again to create more listings\n')

  } catch (error) {
    console.error('âŒ Unexpected error:', error)
    process.exit(1)
  }
}

// Run
createTestListing()

